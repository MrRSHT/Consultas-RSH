<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Consultas Inteligentes con IA</title>

<style>
    body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
    header { background:#003366; color:white; padding:15px; text-align:center; }
    .container { max-width:900px; margin:auto; padding:20px; }
    .card { background:white; padding:20px; border-radius:10px; 
            margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    input, textarea, button {
        width:100%; padding:12px; margin-top:10px; border:1px solid #ccc;
        border-radius:6px; font-size:16px;
    }
    button { background:#003366; color:white; cursor:pointer; }
    button:hover { background:#0055aa; }
    .hidden { display:none; }
    .url-item { padding:10px; border-bottom:1px solid #ddd; }
    .logout { background:darkred; margin-top:20px; }
</style>
</head>
<body>

<header>
    <h1>Consultas Inteligentes con IA</h1>
    <p>El sistema usa IA real para responder preguntas basadas en documentos online</p>
</header>

<div class="container">

    <!-- LOGIN ADMIN -->
    <div id="loginAdmin" class="card">
        <h2>Acceso Administrador</h2>
        <input type="text" id="adminUser" placeholder="Usuario">
        <input type="password" id="adminPass" placeholder="Contraseña">
        <button onclick="login()">Ingresar</button>
    </div>

    <!-- PANEL ADMIN -->
    <div id="panelAdmin" class="card hidden">
        <h2>Panel del Administrador</h2>
        <p>Ingrese URLs de documentos o textos online.</p>

        <input type="text" id="newURL" placeholder="Ingrese URL del documento">
        <button onclick="addURL()">Agregar URL</button>

        <h3>Documentos cargados:</h3>
        <div id="urlList"></div>

        <button class="logout" onclick="logout()">Cerrar sesión</button>
    </div>

    <!-- CONSULTAS -->
    <div id="consultaBox" class="card hidden">
        <h2>Realizar una consulta</h2>
        <textarea id="consulta" rows="4" placeholder="Escriba su pregunta..."></textarea>
        <button onclick="consultarIA()">Consultar con IA</button>

        <h3>Respuesta IA:</h3>
        <div id="respuesta" style="white-space: pre-wrap;"></div>
    </div>

</div>

<script>
    let urls = JSON.parse(localStorage.getItem("urls_docs")) || [];

    function login() {
        const user = document.getElementById("adminUser").value;
        const pass = document.getElementById("adminPass").value;

        if (user === "rshmaule" && pass === "Rsh2025") {
            document.getElementById("loginAdmin").classList.add("hidden");
            document.getElementById("panelAdmin").classList.remove("hidden");
            renderURLs();
        } else {
            alert("Usuario o contraseña incorrectos.");
        }
    }

    function logout() {
        document.getElementById("panelAdmin").classList.add("hidden");
        document.getElementById("loginAdmin").classList.remove("hidden");
    }

    function addURL() {
        const url = document.getElementById("newURL").value;
        if (!url.trim()) return alert("Ingrese una URL válida.");
        urls.push(url);
        localStorage.setItem("urls_docs", JSON.stringify(urls));
        renderURLs();
        document.getElementById("newURL").value = "";
        document.getElementById("consultaBox").classList.remove("hidden");
    }

    function renderURLs() {
        const list = document.getElementById("urlList");
        list.innerHTML = "";
        urls.forEach((u, i) => {
            list.innerHTML += `
                <div class="url-item">
                    ${u}
                    <button onclick="delURL(${i})">Eliminar</button>
                </div>
            `;
        });

        if (urls.length > 0)
            document.getElementById("consultaBox").classList.remove("hidden");
    }

    function delURL(i) {
        urls.splice(i, 1);
        localStorage.setItem("urls_docs", JSON.stringify(urls));
        renderURLs();
    }

    async function consultarIA() {
        const pregunta = document.getElementById("consulta").value.trim();
        if (!pregunta) return alert("Ingrese una pregunta.");

        if (urls.length === 0) {
            document.getElementById("respuesta").innerText = "No hay documentos cargados.";
            return;
        }

        document.getElementById("respuesta").innerText = "Cargando documentos...";

        // 1. Cargar textos desde URLs
        let corpus = "";
        for (let url of urls) {
            try {
                const txt = await fetch(url).then(r => r.text());
                corpus += `\n\n=== Documento: ${url} ===\n\n${txt}`;
            } catch {
                corpus += `\n\nNo se pudo acceder a ${url}\n`;
            }
        }

        // 2. Preparar prompt para la IA
        const prompt = `
Actúa como un asistente experto.
Responde en español LATINO.
Usa SOLO información de los siguientes documentos:

${corpus}

Pregunta del usuario:
"${pregunta}"

Si no encuentras información responde:
"No encontré información suficiente en los documentos."
        `;

        document.getElementById("respuesta").innerText = "Consultando IA...";

        // 3. Llamado a la API real
        const apiKey = window.API_KEY;  // GitHub Pages variable secreta

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                    { role: "system", content: "Eres un asistente experto en análisis documental." },
                    { role: "user", content: prompt }
                ]
            })
        });

        const data = await response.json();
        document.getElementById("respuesta").innerText =
            data.choices?.[0]?.message?.content || "Error al procesar la respuesta.";
    }
</script>

</body>
</html>
